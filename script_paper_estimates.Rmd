---
title: "script_pper_estimates"
output:
  pdf_document: default
  html_document: default
---

```{r message=FALSE, warning=FALSE, include=FALSE,echo=T}
# Load required packages
library(tidyverse)
library(mgcv)
library(mgcViz)
library(tsibble)
library(feasts)
library(lubridate)
library(forecast)
library(modelr)
library(ggplot2)
library(scales)

```

```{r message=FALSE, warning=FALSE, include=FALSE,echo=T}
#detach("package:relaimpo", unload=TRUE)
#detach("package:MASS", unload=TRUE)

# download data of interest - Water Quality
if(file.exists("waq_arik.rda")) {
    waq_arik <- readRDS("waq_arik.rda")
  } else {
    waq_arik <- neonUtilities::loadByProduct(
      dpID = "DP1.20288.001",
      site = "ARIK",
      startdate = "2018-01",
      enddate = "2019-12",
      package = "expanded",
      token = Sys.getenv("NEON_TOKEN"),
      check.size = FALSE
    )
    saveRDS(waq_arik, "waq_arik.rda")
  }

# Take only water quality at the down station
water_quality_arik <- waq_arik$waq_instantaneous %>%
  as_tibble() %>%
  janitor::clean_names() %>%
  filter(horizontal_position == "102") %>%
  select(c(5,19,31,33,45,47,59,61,73,75,87,89,101,103,118)) %>%
  mutate(
    start_date_time = ymd_hms(start_date_time) - second(start_date_time)
  ) %>%
  rename(
    spec_cond = specific_conductance,
    label_spec_cond = specific_cond_final_qf,
    oxygen = dissolved_oxygen,
    label_oxygen = dissolved_oxygen_final_qf,
    oxygen_sat = dissolved_oxygen_saturation,
    label_oxygen_sat = dissolved_oxygen_sat_final_qf,
    ph = p_h,
    label_ph = p_h_final_qf,
    chloro = chlorophyll,
    label_chloro = chlorophyll_final_qf,
    label_turbidity = turbidity_final_qf,
    label_f_dom = f_dom_final_qf
  )

# download data of interest - Nitrate in Suface Water
if(file.exists("nsw_arik.rda")) {
    nsw_arik <- readRDS("nsw_arik.rda")
  } else {
    nsw_arik <-  neonUtilities::loadByProduct(
      dpID="DP1.20033.001",
      site="ARIK",
      startdate = "2018-01",
      enddate = "2019-12",
      package="expanded",
      token = Sys.getenv("NEON_TOKEN"),
      check.size = FALSE
    )
    saveRDS(nsw_arik, "nsw_arik.rda")
  }

# Extract nitrate at 15 minute intervals
nitrate_arik <- nsw_arik$NSW_15_minute %>%
  as_tibble() %>%
  janitor::clean_names() %>%
  mutate(
    start_date_time = ymd_hms(start_date_time) - second(start_date_time)
  ) %>%
  select(c(start_date_time, surf_water_nitrate_mean, final_qf)) %>%
  rename(
    nitrate_mean = surf_water_nitrate_mean,
    label_nitrate_mean = final_qf
  )

# download data of interest - Temperature Suface Water
if(file.exists("temp_arik.rda")) {
    temp_arik <- readRDS("temp_arik.rda")
  } else {
    temp_arik <-  neonUtilities::loadByProduct(
      dpID="DP1.20053.001",
      site="ARIK",
      startdate = "2018-01",
      enddate = "2019-12",
      package="expanded",
      token = Sys.getenv("NEON_TOKEN"),
      check.size = FALSE
    )
    saveRDS(temp_arik, "temp_arik.rda")
  }

# Extract temperature at 15 minute intervals
temp_arik <- temp_arik$TSW_5min %>%
  as_tibble() %>%
  janitor::clean_names()  %>%
  filter(horizontal_position == "101") %>%
  mutate(start_date_time = ymd_hms(start_date_time) - second(start_date_time)) %>%
  select(c(start_date_time, surf_water_temp_mean, final_qf)) %>%
  rename(
    temp_mean = surf_water_temp_mean,
    label_temp_mean = final_qf
  )

# download data of interest - ELEVATION
if(file.exists("level_arik.rda")) {
    level_arik <- readRDS("level_arik.rda")
  } else {
    level_arik <- neonUtilities::loadByProduct(
      dpID = "DP1.20016.001",
      site = "ARIK",
      startdate = "2018-01",
      enddate = "2019-12",
      package = "expanded",
      token = Sys.getenv("NEON_TOKEN"),
      check.size = FALSE
    )
    saveRDS(level_arik, "level_arik.rda")
  }

# Take only water quality at the down station
level_arik <- level_arik$EOS_5_min %>%
  as_tibble() %>%
  janitor::clean_names() %>%
  filter(horizontal_position == "101") %>%
  select(c(5,7,37)) %>%
  mutate(
    start_date_time = ymd_hms(start_date_time) - second(start_date_time)
  ) %>%
  rename(
    elev = surfacewater_elev_mean,
    label_elev = s_wat_elev_final_qf,
    )


# Join water_quality and nitrate, and clean up
data_arik <- left_join(
  nitrate_arik,
  temp_arik,
    by = "start_date_time")
   
data_arik <- left_join(
  data_arik,
  water_quality_arik,
    by = "start_date_time") 
 
data_arik <- left_join(
  data_arik ,
  level_arik,
    by = "start_date_time") 
 

data_arik <- data_arik %>%
  mutate(
    spec_cond = if_else(label_spec_cond == 1, NA_real_, spec_cond),
    oxygen = if_else(label_oxygen == 1, NA_real_, oxygen),
    oxygen_sat = if_else(label_oxygen_sat == 1, NA_real_, oxygen_sat),
    turbidity = if_else(label_turbidity == 1, NA_real_, turbidity),
    ph = if_else(label_ph == 1, NA_real_, ph),
    chloro = if_else(label_chloro == 1, NA_real_, chloro),
    f_dom = if_else(label_f_dom == 1, NA_real_, f_dom),
    temp_mean = if_else(label_temp_mean == 1, NA_real_, temp_mean),
    elev = if_else(label_elev == 1, NA_real_ , elev),
    nitrate_mean = if_else(label_nitrate_mean == 1, NA_real_ , nitrate_mean)
  )  %>%
  distinct(start_date_time, .keep_all=TRUE)

#clear impossible data points
data_arik$turbidity = if_else(data_arik$turbidity < 0, NA_real_ , data_arik$turbidity)
data_arik$spec_cond = if_else(data_arik$spec_cond < 100, NA_real_ , data_arik$spec_cond)
data_arik$nitrate_mean = if_else(data_arik$nitrate_mean  > 25, NA_real_ , data_arik$nitrate_mean)
data_arik$nitrate_mean = if_else(data_arik$nitrate_mean <= 0, NA_real_ , data_arik$nitrate_mean)
data_arik$f_dom = if_else(data_arik$f_dom  > 140, NA_real_ , data_arik$f_dom)

```


```{r message=FALSE, warning=FALSE, include=FALSE,echo=T}
#detach("package:MASS", unload=TRUE)

# download data of interest - Water Quality
if(file.exists("waq_lewi.rda")) {
  waq_lewi <- readRDS("waq_lewi.rda")
} else {
  waq_lewi <- neonUtilities::loadByProduct(
    dpID = "DP1.20288.001",
    site = "LEWI",
startdate = "2018-01",
      enddate = "2019-12",
    package = "expanded",
    token = Sys.getenv("NEON_TOKEN"),
    check.size = FALSE
  )
  saveRDS(waq_lewi, "waq_lewi.rda")
}

# Take only water quality at the down station
water_quality_lewi <- waq_lewi$waq_instantaneous %>%
  as_tibble() %>%
  janitor::clean_names() %>%
  filter(horizontal_position == "102") %>%
  select(c(5,19,31,33,45,47,59,61,73,75,87,89,101,103,118)) %>%
  mutate(
    start_date_time = ymd_hms(start_date_time) - second(start_date_time)
  ) %>%
  rename(
    spec_cond = specific_conductance,
    label_spec_cond = specific_cond_final_qf,
    oxygen = dissolved_oxygen,
    label_oxygen = dissolved_oxygen_final_qf,
    oxygen_sat = dissolved_oxygen_saturation,
    label_oxygen_sat = dissolved_oxygen_sat_final_qf,
    ph = p_h,
    label_ph = p_h_final_qf,
    chloro = chlorophyll,
    label_chloro = chlorophyll_final_qf,
    label_turbidity = turbidity_final_qf,
    label_f_dom = f_dom_final_qf
  )

# download data of interest - Nitrate in Suface Water
if(file.exists("nsw_lewi.rda")) {
  nsw_lewi <- readRDS("nsw_lewi.rda")
} else {
  nsw_lewi <-  neonUtilities::loadByProduct(
    dpID="DP1.20033.001",
    site="LEWI",
startdate = "2018-01",
      enddate = "2019-12",
    package="expanded",
    token = Sys.getenv("NEON_TOKEN"),
    check.size = FALSE
  )
  saveRDS(nsw_lewi, "nsw_lewi.rda")
}

# Extract nitrate at 15 minute intervals
nitrate_lewi <- nsw_lewi$NSW_15_minute %>%
  as_tibble() %>%
  janitor::clean_names() %>%
  mutate(
    start_date_time = ymd_hms(start_date_time) - second(start_date_time)
  ) %>%
  select(c(start_date_time, surf_water_nitrate_mean, final_qf)) %>%
  rename(
    nitrate_mean = surf_water_nitrate_mean,
    label_nitrate_mean = final_qf
  )

# download data of interest - Temperature Suface Water
if(file.exists("temp_lewi.rda")) {
    temp_lewi <- readRDS("temp_lewi.rda")
  } else {
    temp_lewi <-  neonUtilities::loadByProduct(
      dpID="DP1.20053.001",
      site="LEWI",
startdate = "2018-01",
      enddate = "2019-12",
      package="expanded",
      token = Sys.getenv("NEON_TOKEN"),
      check.size = FALSE
    )
    saveRDS(temp_lewi, "temp_lewi.rda")
  }

# Extract nitrate at 15 minute intervals
temp_lewi <- temp_lewi$TSW_5min %>%
  as_tibble() %>%
  janitor::clean_names()  %>%
  filter(horizontal_position == "101") %>%
  mutate(start_date_time = ymd_hms(start_date_time) - second(start_date_time)) %>%
  select(c(start_date_time, surf_water_temp_mean, final_qf)) %>%
  rename(
    temp_mean = surf_water_temp_mean,
    label_temp_mean = final_qf
  )

# download data of interest - ELEVATION
if(file.exists("level_lewi.rda")) {
    level_lewi <- readRDS("level_lewi.rda")
  } else {
    level_lewi <- neonUtilities::loadByProduct(
      dpID = "DP1.20016.001",
      site = "LEWI",
startdate = "2018-01",
      enddate = "2019-12",
      package = "expanded",
      token = Sys.getenv("NEON_TOKEN"),
      check.size = FALSE
    )
    saveRDS(level_lewi, "level_lewi.rda")
  }

# Take only water quality at the down station
level_lewi <- level_lewi$EOS_5_min %>%
  as_tibble() %>%
  janitor::clean_names() %>%
  filter(horizontal_position == "101") %>%
  select(c(5,7,37)) %>%
  mutate(
    start_date_time = ymd_hms(start_date_time) - second(start_date_time)
  ) %>%
  rename(
    elev = surfacewater_elev_mean,
    label_elev = s_wat_elev_final_qf,
    )


# Join water_quality and nitrate, and clean up
data_lewi <- left_join(
  nitrate_lewi,
  temp_lewi,
    by = "start_date_time")
   
data_lewi <- left_join(
  data_lewi,
  water_quality_lewi,
    by = "start_date_time") 
 
data_lewi <- left_join(
  data_lewi ,
  level_lewi,
    by = "start_date_time") 
 

data_lewi <- data_lewi %>%
  mutate(
    spec_cond = if_else(label_spec_cond == 1, NA_real_, spec_cond),
    oxygen = if_else(label_oxygen == 1, NA_real_, oxygen),
    oxygen_sat = if_else(label_oxygen_sat == 1, NA_real_, oxygen_sat),
    turbidity = if_else(label_turbidity == 1, NA_real_, turbidity),
    ph = if_else(label_ph == 1, NA_real_, ph),
    chloro = if_else(label_chloro == 1, NA_real_, chloro),
    f_dom = if_else(label_f_dom == 1, NA_real_, f_dom),
    temp_mean = if_else(label_temp_mean == 1, NA_real_, temp_mean),
    elev = if_else(label_elev == 1, NA_real_ , elev),
    nitrate_mean = if_else(label_nitrate_mean == 1, NA_real_ , nitrate_mean)
  )  %>%
  distinct(start_date_time, .keep_all=TRUE)
   


#clear impossible data points
data_lewi$nitrate_mean = if_else(data_lewi$nitrate_mean <= 5, NA_real_ , data_lewi$nitrate_mean)
data_lewi$turbidity = if_else(data_lewi$turbidity < 0, NA_real_ , data_lewi$turbidity)
data_lewi$temp_mean = if_else(data_lewi$temp_mean < 0, NA_real_ , data_lewi$temp_mean)
```



```{r message=FALSE, warning=FALSE, include=FALSE, echo=T}
# detach("package:MASS", unload=TRUE)
# download data of interest - Water Quality
if(file.exists("waq.rda")) {
    waq <- readRDS("waq.rda")
  } else {
    waq <- neonUtilities::loadByProduct(
      dpID = "DP1.20288.001",
      site = "CARI",
      startdate = "2018-01",
      enddate = "2019-12",
      package = "expanded",
      token = Sys.getenv("NEON_TOKEN"),
      check.size = FALSE
    )
    saveRDS(waq, "waq.rda")
  }

# Take only water quality at the down station
water_quality <- waq$waq_instantaneous %>%
  as_tibble() %>%
  janitor::clean_names() %>%
  filter(horizontal_position == "102") %>%
  select(c(5,19,31,33,45,47,59,61,73,75,87,89,101,103,118)) %>%
  mutate(
    start_date_time = ymd_hms(start_date_time) - second(start_date_time)
  ) %>%
  rename(
    spec_cond = specific_conductance,
    label_spec_cond = specific_cond_final_qf,
    oxygen = dissolved_oxygen,
    label_oxygen = dissolved_oxygen_final_qf,
    oxygen_sat = dissolved_oxygen_saturation,
    label_oxygen_sat = dissolved_oxygen_sat_final_qf,
    ph = p_h,
    label_ph = p_h_final_qf,
    chloro = chlorophyll,
    label_chloro = chlorophyll_final_qf,
    label_turbidity = turbidity_final_qf,
    label_f_dom = f_dom_final_qf
  )

# download data of interest - Nitrate in Suface Water
if(file.exists("nsw.rda")) {
    nsw <- readRDS("nsw.rda")
  } else {
    nsw <-  neonUtilities::loadByProduct(
      dpID="DP1.20033.001",
      site="CARI",
     startdate = "2018-01",
      enddate = "2019-12",
      package="expanded",
      token = Sys.getenv("NEON_TOKEN"),
      check.size = FALSE
    )
    saveRDS(nsw, "nsw.rda")
  }

# Extract nitrate at 15 minute intervals
nitrate <- nsw$NSW_15_minute %>%
  as_tibble() %>%
  janitor::clean_names() %>%
  mutate(
    start_date_time = ymd_hms(start_date_time) - second(start_date_time)
  ) %>%
  select(c(start_date_time, surf_water_nitrate_mean, final_qf)) %>%
  rename(
    nitrate_mean = surf_water_nitrate_mean,
    label_nitrate_mean = final_qf
  )




# download data of interest - Temperature Suface Water
if(file.exists("temp_cari.rda")) {
    temp_cari <- readRDS("temp_cari.rda")
  } else {
    temp_cari <-  neonUtilities::loadByProduct(
      dpID="DP1.20053.001",
      site="CARI",
      startdate = "2018-01",
      enddate = "2019-12",
      package="expanded",
      token = Sys.getenv("NEON_TOKEN"),
      check.size = FALSE
    )
    saveRDS(temp_cari, "temp_cari.rda")
  }

# Extract nitrate at 15 minute intervals
temp_cari <- temp_cari$TSW_5min %>%
  as_tibble() %>%
  janitor::clean_names()  %>%
  filter(horizontal_position == "101") %>%
  mutate(start_date_time = ymd_hms(start_date_time) - second(start_date_time)) %>%
  select(c(start_date_time, surf_water_temp_mean, final_qf)) %>%
  rename(
    temp_mean = surf_water_temp_mean,
    label_temp_mean = final_qf
  )


# download data of interest - ELEVATION
if(file.exists("level_cari.rda")) {
    level_cari <- readRDS("level_cari.rda")
  } else {
    level_cari <- neonUtilities::loadByProduct(
      dpID = "DP1.20016.001",
      site = "CARI",
      startdate = "2018-01",
      enddate = "2019-12",
      package = "expanded",
      token = Sys.getenv("NEON_TOKEN"),
      check.size = FALSE
    )
    saveRDS(level_cari, "level_cari.rda")
  }

# Take only water quality at the down station
level_cari <- level_cari$EOS_5_min %>%
  as_tibble() %>%
  janitor::clean_names() %>%
  filter(horizontal_position == "101") %>%
  select(c(5,7,37)) %>%
  mutate(
    start_date_time = ymd_hms(start_date_time) - second(start_date_time)
  ) %>%
  rename(
    elev = surfacewater_elev_mean,
    label_elev = s_wat_elev_final_qf,
    )


# Join water_quality and nitrate, and clean up
data_cari <- left_join(
  nitrate,
  temp_cari,
    by = "start_date_time")
   
data_cari <- left_join(
  data_cari,
  water_quality,
    by = "start_date_time") 
 
data_cari <- left_join(
  data_cari ,
  level_cari,
    by = "start_date_time") 
 

data_cari <- data_cari %>%
  mutate(
    spec_cond = if_else(label_spec_cond == 1, NA_real_, spec_cond),
    oxygen = if_else(label_oxygen == 1, NA_real_, oxygen),
    oxygen_sat = if_else(label_oxygen_sat == 1, NA_real_, oxygen_sat),
    turbidity = if_else(label_turbidity == 1, NA_real_, turbidity),
    ph = if_else(label_ph == 1, NA_real_, ph),
    chloro = if_else(label_chloro == 1, NA_real_, chloro),
    f_dom = if_else(label_f_dom == 1, NA_real_, f_dom),
    temp_mean = if_else(label_temp_mean == 1, NA_real_, temp_mean),
    elev = if_else(label_elev == 1, NA_real_ , elev),
    nitrate_mean = if_else(label_nitrate_mean == 1, NA_real_ , nitrate_mean)
  )  %>%
  distinct(start_date_time, .keep_all=TRUE)
   


# Clear impossible data
data_cari = distinct(data_cari, start_date_time, .keep_all = TRUE)
data_cari$turbidity = if_else(data_cari$turbidity > 500, NA_real_ , data_cari$turbidity)
data_cari$nitrate_mean = if_else(data_cari$nitrate_mean > 50, NA_real_ , data_cari$nitrate_mean)
data_cari$chloro = if_else(data_cari$chloro > 200, NA_real_ , data_cari$chloro)
data_cari$spec_cond = if_else(data_cari$spec_cond > 300, NA_real_ , data_cari$spec_cond)
```

```{r ,echo=T}
# add a colomn time recod to both site
data_cari$time_recod <- seq(from = 1, to = nrow(data_cari))
data_arik$time_recod <- seq(from = 1, to = nrow(data_arik))
data_lewi$time_recod <- seq(from = 1, to = nrow(data_lewi))
```

# SI - data visualisation

## data at Caribou

```{r echo=FALSE, message=FALSE, warning=FALSE}
data<-data_cari
## Plot data
data %>%
  dplyr::select(start_date_time, nitrate_mean, turbidity, temp_mean, spec_cond, oxygen, elev ) %>%
  pivot_longer(-start_date_time, names_to = "variable") %>%
  ggplot(aes(x = start_date_time , y = value, col = variable)) +
  geom_point() +
  facet_grid(rows = vars(variable),  scales = "free", space="free_x") +
  labs(y = "", x = "Time") +
  scale_x_datetime(date_labels ="%m") +
  theme(legend.position = "none")
```


## data at Arikaree

```{r echo=FALSE, message=FALSE, warning=FALSE}
data<-data_arik
## Plot data
data %>%
  dplyr::select(start_date_time, nitrate_mean, turbidity, temp_mean, spec_cond, oxygen, elev ) %>%
  dplyr::rename(start_date_time = "start_date_time", "Nitrate" = nitrate_mean, "Turbidity" = turbidity, "Temperature" =  temp_mean,  "Spec.cond" = spec_cond, "Oxygen" = oxygen,"Elevation"  = elev ) %>%
  pivot_longer(-start_date_time, names_to = "variable") %>%
  ggplot(aes(x = start_date_time , y = value, col = variable)) +
  geom_point() +
  facet_grid(rows = vars(variable),  scales = "free", space="free_x") +
  labs(y = "", x = "") +
  scale_x_datetime(date_labels ="%Y-%m") +
  theme(legend.position = "none")+
  ggtitle("Arikaree")


```


## data at LEWI

```{r echo=FALSE, message=FALSE, warning=FALSE}
data<-data_lewi
## Plot data
data %>%
  dplyr::select(start_date_time, nitrate_mean, turbidity, temp_mean, spec_cond, oxygen, elev ) %>%
  dplyr::rename(start_date_time = "start_date_time", "Nitrate" = nitrate_mean, "Turbidity" = turbidity, "Temperature" =  temp_mean,  "Spec.cond" = spec_cond, "Oxygen" = oxygen,"Elevation"  = elev ) %>%
  pivot_longer(-start_date_time, names_to = "variable") %>%
  ggplot(aes(x = start_date_time , y = value, col = variable)) +
  geom_point() +
  facet_grid(rows = vars(variable),  scales = "free", space="free_x") +
  labs(y = "", x = "") +
  scale_x_datetime(date_labels ="%Y-%m") +
  theme(legend.position = "none") +
  ggtitle("Lewis Run")


```

```{r}
scale_override <- function(which, scale) {
  if(!is.numeric(which) || (length(which) != 1) || (which %% 1 != 0)) {
    stop("which must be an integer of length 1")
  }
  
  if(is.null(scale$aesthetics) || !any(c("x", "y") %in% scale$aesthetics)) {
    stop("scale must be an x or y position scale")
  }
  
  structure(list(which = which, scale = scale), class = "scale_override")
}

CustomFacetWrap <- ggproto(
  "CustomFacetWrap", FacetWrap,
  init_scales = function(self, layout, x_scale = NULL, y_scale = NULL, params) {
    # make the initial x, y scales list
    scales <- ggproto_parent(FacetWrap, self)$init_scales(layout, x_scale, y_scale, params)
    
    if(is.null(params$scale_overrides)) return(scales)
    
    max_scale_x <- length(scales$x)
    max_scale_y <- length(scales$y)
    
    # ... do some modification of the scales$x and scales$y here based on params$scale_overrides
    for(scale_override in params$scale_overrides) {
      which <- scale_override$which
      scale <- scale_override$scale
      
      if("x" %in% scale$aesthetics) {
        if(!is.null(scales$x)) {
          if(which < 0 || which > max_scale_x) stop("Invalid index of x scale: ", which)
          scales$x[[which]] <- scale$clone()
        }
      } else if("y" %in% scale$aesthetics) {
        if(!is.null(scales$y)) {
          if(which < 0 || which > max_scale_y) stop("Invalid index of y scale: ", which)
          scales$y[[which]] <- scale$clone()
        }
      } else {
        stop("Invalid scale")
      }
    }
    
    # return scales
    scales
  }
)

facet_wrap_custom <- function(..., scale_overrides = NULL) {
  # take advantage of the sanitizing that happens in facet_wrap
  facet_super <- facet_wrap(...)
  
  # sanitize scale overrides
  if(inherits(scale_overrides, "scale_override")) {
    scale_overrides <- list(scale_overrides)
  } else if(!is.list(scale_overrides) || 
            !all(vapply(scale_overrides, inherits, "scale_override", FUN.VALUE = logical(1)))) {
    stop("scale_overrides must be a scale_override object or a list of scale_override objects")
  }
  
  facet_super$params$scale_overrides <- scale_overrides
  
  ggproto(NULL, CustomFacetWrap,
    shrink = facet_super$shrink,
    params = facet_super$params
  )
}
```


# Figure 2

```{r message=FALSE, warning=FALSE}
Sys.setlocale("LC_TIME", "en_US.UTF-8") # for months not to be written in french

## Plot cari data
start <- which(data_cari$start_date_time == "2019-07-01 10:00:00 UTC")
end <- which(data_cari$start_date_time == "2019-07-06 10:00:00 UTC")

data<-data_cari[c(start:end),] 
g1<-data %>%
  dplyr::select(start_date_time, nitrate_mean, turbidity, temp_mean, spec_cond, oxygen, elev ) %>%
  dplyr::rename(start_date_time = start_date_time, Elev. = elev, "N03-" = nitrate_mean, O2 = oxygen, Cond =  spec_cond, Temp. = temp_mean, Turb. = turbidity) %>%
  pivot_longer(-start_date_time, names_to = "variable") %>%
  ggplot(aes(x = start_date_time , y = value, col = variable)) + ggtitle("Caribou") +
  geom_point() +
  facet_wrap_custom(~ variable,  ncol = 1, scales = "free_y", strip.position="right",  scale_overrides = list(
    scale_override(1, scale_y_continuous(breaks = c(96,102))),
    scale_override(2, scale_y_continuous(breaks = c(230.03,230.04))),
    scale_override(3, scale_y_continuous(breaks = c(22,22.8))),
    scale_override(4, scale_y_continuous(breaks = c(10.4,11.6))),
    scale_override(5, scale_y_continuous(breaks = c(4,12))),
    scale_override(6, scale_y_continuous(breaks = c(2,5)))
  )) +
  labs(y = "", x = "") +
  scale_x_datetime(date_labels ="%b:%d", breaks=date_breaks("2 days")) +
  theme(legend.position = "none",
        strip.text.y = element_text(size = 6),
        axis.text.y= element_text(size = 8),
        axis.text.x= element_text(size = 8))


## Plot arik data
start <- which(data_arik$start_date_time == "2019-07-01 10:00:00 UTC")
end <- which(data_arik$start_date_time == "2019-07-06 10:00:00 UTC")

data<-data_arik[c(start:end),] 
g2<-data %>%
  dplyr::select(start_date_time, nitrate_mean, turbidity, temp_mean, spec_cond, oxygen, elev ) %>%
  dplyr::rename(start_date_time = start_date_time, Elev. = elev, "N03-" = nitrate_mean, O2 = oxygen, Cond =  spec_cond, Temp. = temp_mean, Turb. = turbidity) %>%
  pivot_longer(-start_date_time, names_to = "variable") %>%
  ggplot(aes(x = start_date_time , y = value, col = variable)) + ggtitle("Arikaree") +
  geom_point() +
  facet_wrap_custom(~ variable,  ncol = 1, scales = "free_y", strip.position="right",  scale_overrides = list(
    scale_override(1, scale_y_continuous(breaks = c(535,540))),
    scale_override(2, scale_y_continuous(breaks = c(1179.75,1179.79))),
    scale_override(3, scale_y_continuous(breaks = c(4,6))),
    scale_override(4, scale_y_continuous(breaks = c(2.5,7.5))),
    scale_override(5, scale_y_continuous(breaks = c(21,25))),
    scale_override(6, scale_y_continuous(breaks = c(3,7)))
  )) +
  labs(y = "", x = "") +
  scale_x_datetime(date_labels ="%b:%d", breaks=date_breaks("2 days")) +
  theme(legend.position = "none",
        strip.text.y = element_text(size = 6),
        axis.text.y= element_text(size = 8),
        axis.text.x= element_text(size = 8))
## Plot lewi data
start <- which(data_lewi$start_date_time == "2018-03-22 10:00:00 UTC")
end <- which(data_lewi$start_date_time == "2018-03-27 10:00:00 UTC")

data<-data_lewi[c(start:end),]
g3<-data %>%
  dplyr::select(start_date_time, nitrate_mean, turbidity, temp_mean, spec_cond, oxygen, elev ) %>%
  dplyr::rename(start_date_time = start_date_time, Elev. = elev, "N03-" = nitrate_mean, O2 = oxygen, Cond =  spec_cond, Temp. = temp_mean, Turb. = turbidity) %>%
  pivot_longer(-start_date_time, names_to = "variable") %>%
  ggplot(aes(x = start_date_time , y = value, col = variable)) + ggtitle("Lewis Run") +
  geom_point() +
  facet_wrap_custom(~ variable,  ncol = 1, scales = "free_y", strip.position="right",  scale_overrides = list(
    scale_override(1, scale_y_continuous(breaks = c(570,630))),
    scale_override(2, scale_y_continuous(breaks = c(125.9,125.96))),
    scale_override(3, scale_y_continuous(breaks = c(170,200))),
    scale_override(4, scale_y_continuous(breaks = c(10,12.5))),
    scale_override(5, scale_y_continuous(breaks = c(6,12))),
    scale_override(6, scale_y_continuous(breaks = c(0,20)))
  )) +
  labs(y = "", x = "") +
  scale_x_datetime(date_labels ="%b:%d", breaks=date_breaks("2 days")) +
  theme(legend.position = "none",
        strip.text.y = element_text(size = 6),
        axis.text.y= element_text(size = 8),
        axis.text.x= element_text(size = 8))

#cari with peak
start <- which(data_cari$start_date_time == "2019-08-02 15:00:00 UTC")
end <- which(data_cari$start_date_time == "2019-08-05 15:00:00 UTC")

data<-data_cari[start:end, ] 
g4<-data %>%
  dplyr::select(start_date_time, nitrate_mean, turbidity, temp_mean, spec_cond, oxygen, elev ) %>%
  dplyr::rename(start_date_time = start_date_time, Elev. = elev, "N03-" = nitrate_mean, O2 = oxygen, Cond =  spec_cond, Temp. = temp_mean, Turb. = turbidity) %>%
  pivot_longer(-start_date_time, names_to = "variable") %>%
  ggplot(aes(x = start_date_time , y = value, col = variable)) +
  geom_point() +
  facet_wrap_custom(~ variable,  ncol = 1, scales = "free_y", strip.position="right",  scale_overrides = list(
    scale_override(1, scale_y_continuous(breaks = c(40,60))),
    scale_override(2, scale_y_continuous(breaks = c(230.2,230.8))),
    scale_override(3, scale_y_continuous(breaks = c(27.5,35))),
    scale_override(4, scale_y_continuous(breaks = c(11.5,12.5))),
    scale_override(5, scale_y_continuous(breaks = c(3,5))),
    scale_override(6, scale_y_continuous(breaks = c(0,90)))
  )) +
  labs(y = "", x = "") +
  scale_x_datetime(date_labels ="%b:%d", breaks=date_breaks("1 day")) +
  theme(legend.position = "none",
        strip.text.y = element_text(size = 6),
        axis.text.y= element_text(size = 8),
        axis.text.x= element_text(size = 8))

# arik with peack
start <- which(data_arik$start_date_time == "2019-07-20 19:15:00 UTC")
end <- which(data_arik$start_date_time == "2019-07-23 19:15:00 UTC")
data<-data_arik[c(start:end),] 
g5<-data %>%
  dplyr::select(start_date_time, nitrate_mean, turbidity, temp_mean, spec_cond, oxygen, elev ) %>%
  dplyr::rename(start_date_time = start_date_time, Elev. = elev, "N03-" = nitrate_mean, O2 = oxygen, Cond =  spec_cond, Temp. = temp_mean, Turb. = turbidity) %>%
  pivot_longer(-start_date_time, names_to = "variable") %>%
  ggplot(aes(x = start_date_time , y = value, col = variable)) +
  geom_point() +
  facet_wrap_custom(~ variable,  ncol = 1, scales = "free_y", strip.position="right",  scale_overrides = list(
    scale_override(1, scale_y_continuous(breaks = c(400,550))),
    scale_override(2, scale_y_continuous(breaks = c(1179.52,1179.60))),
    scale_override(3, scale_y_continuous(breaks = c(0,15))),
    scale_override(4, scale_y_continuous(breaks = c(2,6))),
    scale_override(5, scale_y_continuous(breaks = c(20,27.5))),
    scale_override(6, scale_y_continuous(breaks = c(10,40)))
  )) +
  labs(y = "", x = "") +
  scale_x_datetime(date_labels ="%b:%d", breaks=date_breaks("1 day")) +
  theme(legend.position = "none",
        strip.text.y = element_text(size = 6),
        axis.text.y= element_text(size = 8),
        axis.text.x= element_text(size = 8))

## Plot lewi data peak
start <- which(data_lewi$start_date_time == "2019-07-22 10:00:00 UTC")
end <- which(data_lewi$start_date_time == "2019-07-24 10:00:00 UTC")

data<-data_lewi[c(start:end),]
g6<-data %>%
  dplyr::select(start_date_time, nitrate_mean, turbidity, temp_mean, spec_cond, oxygen, elev ) %>%
  dplyr::rename(start_date_time = start_date_time, Elev. = elev, "N03-" = nitrate_mean, O2 = oxygen, Cond =  spec_cond, Temp. = temp_mean, Turb. = turbidity) %>%
  pivot_longer(-start_date_time, names_to = "variable") %>%
  ggplot(aes(x = start_date_time , y = value, col = variable)) +
  geom_point() +
  facet_wrap_custom(~ variable,  ncol = 1, scales = "free_y", strip.position="right",  scale_overrides = list(
    scale_override(1, scale_y_continuous(breaks = c(400,550))),
    scale_override(2, scale_y_continuous(breaks = c(126.1,126.2))),
    scale_override(3, scale_y_continuous(breaks = c(100,200))),
    scale_override(4, scale_y_continuous(breaks = c(8,8.6))),
    scale_override(5, scale_y_continuous(breaks = c(17,21))),
    scale_override(6, scale_y_continuous(breaks = c(200,600)))
  )) +
  labs(y = "", x = "") +
  scale_x_datetime(date_labels ="%b:%d", breaks=date_breaks("1 day")) +
  theme(legend.position = "none",
        strip.text.y = element_text(size = 6),
        axis.text.y= element_text(size = 8),
        axis.text.x= element_text(size = 8))

```

```{r message=FALSE, warning=FALSE}
gridExtra::grid.arrange(g2, g1,g3, g5, g4, g6, layout_matrix = rbind(c(1,2,3), c(4,5,6)))
```




# Figure 1

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(reshape2)
data_plot_arik<-cbind(data_arik[,c(2,4,6,8,20)], log(data_arik$turbidity +1))
colnames(data_plot_arik) <- c("Nitrate","Temperature","Spec. Cond.", "Diss. Oxygen" , "Elevation", "log_Turbidity")
data_plot_arik<-melt(data_plot_arik)
data_plot_arik$site<-rep("Arikaree", length = length(data_plot_arik[,1]))


data_plot_cari<-cbind(data_cari[,c(2,4,6,8,20)], log(data_cari$turbidity +1))
colnames(data_plot_cari) <- c("Nitrate", "Temperature","Spec. Cond.", "Diss. Oxygen", "Elevation", "log_Turbidity")
data_plot_cari<-melt(data_plot_cari)
data_plot_cari$site<-rep("Caribou", length = length(data_plot_cari[,1]))

data_plot_lewi<-cbind(data_lewi[,c(2,4,6,8,20)], log(data_lewi$turbidity +1))
colnames(data_plot_lewi) <- c("Nitrate", "Temperature","Spec. Cond.", "Diss. Oxygen", "Elevation", "log_Turbidity")
data_plot_lewi<-melt(data_plot_lewi)
data_plot_lewi$site<-rep("Lewis Run", length = length(data_plot_lewi[,1]))



data_both<- rbind(data_plot_arik, data_plot_cari, data_plot_lewi)


gg<-ggplot(data = data_both[which(data_both$variable == "Nitrate"),], aes(factor(1), value, color = site)) +
  geom_boxplot() +  facet_wrap(~variable,scales="free",ncol=3) + 
  ylab(expression("Nitrate ("~mu~"M)"))+ 
  scale_color_manual(values=c("#440154FF", "#277F8EFF", "#9FDA3AFF"))+
  theme(axis.text.x=element_blank(),
        axis.text.y= element_text(size = 11),
        axis.title.x=element_blank(), 
        legend.position= "none",
        axis.title.y = element_text(),
        legend.title = element_blank(),
        strip.text.x = element_blank())

gg1<-ggplot(data = data_both[which(data_both$variable == "Temperature"),], aes(factor(1), value, color = site)) +
  geom_boxplot() +  facet_wrap(~variable,scales="free",ncol=3) + ylab("Temperature (째C)")+ 
  scale_color_manual(values=c("#440154FF", "#277F8EFF", "#9FDA3AFF"))+
  theme(axis.text.x=element_blank(),
        axis.text.y= element_text(size = 11),
        axis.title.x=element_blank(), 
        axis.title.y = element_text(),
        legend.position= "none",
        legend.title = element_blank(),
        strip.text.x = element_blank())

gg2<-ggplot(data = data_both[which(data_both$variable == "Spec. Cond."),], aes(factor(1), value, color = site)) +
  geom_boxplot() +  facet_wrap(~variable,scales="free",ncol=3) +
  ylab(expression("Specific conductance ("~mu~"S/cm)")) + 
  scale_color_manual(values=c("#440154FF", "#277F8EFF", "#9FDA3AFF"))+
  theme(plot.margin = unit(c(0.2,1.0,0.2, 0.2), "cm"),
        axis.text.x=element_blank(),
        axis.text.y= element_text(size = 11),
        legend.text=element_text(size=14),
        axis.title.x=element_blank(), 
        axis.title.y = element_text(),
        legend.position="right",
        legend.direction="vertical",
        legend.title = element_blank(),
        strip.text.x = element_blank())
gg3<-ggplot(data = data_both[which(data_both$variable == "Diss. Oxygen"),], aes(factor(1), value, color = site)) +
  geom_boxplot() +  facet_wrap(~variable,scales="free",ncol=3) + ylab("Dissolved oxygen (mg/L)")+ 
  scale_color_manual(values=c("#440154FF", "#277F8EFF", "#9FDA3AFF"))+
  theme(axis.text.x=element_blank(),
        axis.text.y= element_text(size = 11),
        axis.title.x=element_blank(), 
        axis.title.y = element_text(),
        legend.position= "none",
        legend.title = element_blank(),
        strip.text.x = element_blank())
gg4<-ggplot(data = data_both[which(data_both$variable == "log_Turbidity"),], aes(factor(1), value, color = site)) +
  geom_boxplot() +  facet_wrap(~variable,scales="free",ncol=3)+ ylab("Log transformed turbidity (FNU)") +
  scale_color_manual(values=c("#440154FF", "#277F8EFF", "#9FDA3AFF"))+
  theme(axis.text.x=element_blank(),
        axis.text.y= element_text(size = 11),
        axis.title.x=element_blank(), 
        axis.title.y = element_text(),
        legend.position= "none",
        legend.title = element_blank(),
        strip.text.x = element_blank())

gg5<-ggplot(data = data_both[which(data_both$variable == "Elevation"),], aes(factor(1), value, color = site)) +
  geom_boxplot() +  facet_wrap(~variable,scales="free",ncol=3)+ ylab("Elevation (m)") +
  scale_color_manual(values=c("#440154FF", "#277F8EFF", "#9FDA3AFF"))+
  theme(axis.text.x=element_blank(),
        axis.text.y= element_text(size = 11),
        axis.title.x=element_blank(), 
        axis.title.y = element_text(),
        legend.position= "none",
        legend.title = element_blank(),
        strip.text.x = element_blank())
blank <- grid::grid.rect(gp=grid::gpar(col="white"))

gridExtra::grid.arrange(gg, gg1, gg2,gg3,gg4, gg5, blank, layout_matrix = rbind(c(1,2,3,3),c(4,5,6,7)), widths = c(1, 1, 1, 1))



```



# GAM Models

## Caribou

```{r message=FALSE, warning=FALSE, eval=F, echo=T}
library(gam)
model_gam_cari<-gam::gam(nitrate_mean ~ spec_cond + oxygen + oxygen_sat + chloro + ph + f_dom + turbidity , data = data_cari)

step_model_gam<-gam::step.Gam(model_gam_cari, scope=list("spec_cond"=~1+spec_cond+s(spec_cond,4)+s(spec_cond,6)+s(spec_cond,12),
                               "oxygen"=~1+oxygen+s(oxygen,4)+s(oxygen,5)+s(oxygen,6),
                               "oxygen_sat"=~1+oxygen_sat+s(oxygen_sat,4)+s(oxygen_sat,5)+s(oxygen_sat,6),
                               "chloro"=~1+chloro+s(chloro,4)+s(chloro,5)+s(chloro,6),
                               "ph"=~1+ph+s(ph,4)+s(ph,5)+s(ph,6),
                               "f_dom"=~1+f_dom+s(f_dom,4)+s(f_dom,5)+s(f_dom,6),
                               "turbidity"=~1+turbidity+s(turbidity,4)+s(turbidity,5)+s(turbidity,6)))
```


```{r}

best_model_gam_cari<-mgcv::gam(nitrate_mean ~  s(spec_cond, k = 6) + s(oxygen, k = 6) + s(temp_mean, k = 6) + s(log(turbidity+1) ,  k = 6) + s(time_recod, k = 6)+ s(elev, k = 6), data = data_cari, na.action=na.exclude)

#fill where we deleted na
data_cari <- data_cari %>%
  mutate(gam_res = residuals(best_model_gam_cari)) %>%
  as_tsibble(index=start_date_time) %>%
  fill_gaps()

gam_prediction<-predict(best_model_gam_cari, data_cari)

data_rmse<- cbind(data_cari$nitrate_mean,gam_prediction)
data_rmse<-data_rmse[complete.cases(data_rmse),]
rmse_cari<-Metrics::rmse(data_rmse[,1], data_rmse[,2])

cari_res <- c(rmse_cari,best_model_gam_cari$gcv.ubre)

# for next plot
best_model_gam_cari<-mgcv::gam(nitrate_mean ~  s(spec_cond, k = 6) + s(oxygen, k = 6) + 
                            +  s(temp_mean, k = 6) +
                            s(log(turbidity+1) ,  k = 6)+ s(time_recod, k = 6) + s(elev, k = 6), data = data_cari)
summary(best_model_gam_cari)
```

## ARIK

```{r  include=FALSE, eval=F, echo=T}
library(gam)
model_gam_arik<-gam::gam(nitrate_mean ~ spec_cond + oxygen + oxygen_sat + chloro + ph + f_dom + turbidity , data = data_arik)

step_model_gam<-gam::step.Gam(model_gam_arik, scope=list("spec_cond"=~1+spec_cond+s(spec_cond,4)+s(spec_cond,6)+s(spec_cond,12),
                               "oxygen"=~1+oxygen+s(oxygen,4)+s(oxygen,5)+s(oxygen,6),
                               "oxygen_sat"=~1+oxygen_sat+s(oxygen_sat,4)+s(oxygen_sat,5)+s(oxygen_sat,6),
                               "chloro"=~1+chloro+s(chloro,4)+s(chloro,5)+s(chloro,6),
                               "ph"=~1+ph+s(ph,4)+s(ph,5)+s(ph,6),
                               "f_dom"=~1+f_dom+s(f_dom,4)+s(f_dom,5)+s(f_dom,6),
                               "turbidity"=~1+turbidity+s(turbidity,4)+s(turbidity,5)+s(turbidity,6)))
```



```{r echo=T, message=FALSE, warning=FALSE, include=FALSE}
best_model_gam_arik<-mgcv::gam(nitrate_mean ~  s(spec_cond, k = 6) + s(oxygen, k = 6) +  s(temp_mean, k = 6) + s(log(turbidity + 1 ),  k = 6)+ s(time_recod, k = 6) + s(elev, k = 6),  data = data_arik, na.action=na.exclude)

#fill where we deleted na
data_arik <- data_arik %>%
  mutate(gam_res = residuals(best_model_gam_arik)) %>%
  as_tsibble(index=start_date_time) %>%
  fill_gaps()

gam_prediction<-predict(best_model_gam_arik, data_arik)

data_rmse <- cbind(data_arik$nitrate_mean,gam_prediction)
data_rmse <- data_rmse[complete.cases(data_rmse),]
rmse_arik <- Metrics::rmse(data_rmse[,1], data_rmse[,2])

arik_res <- c(rmse_arik, best_model_gam_arik$gcv.ubre)


# for next plot
best_model_gam_arik<-mgcv::gam(nitrate_mean ~  s(spec_cond, k = 6) + s(oxygen, k = 6) + 
                            +  s(temp_mean, k = 6) +
                            s(log(turbidity+1) ,  k = 6)+ s(time_recod, k = 6)+ s(elev, k = 6), data = data_arik)

summary(best_model_gam_arik)
```



## LEWI

```{r include=FALSE, eval=F, echo=T}
library(gam)
model_gam_lewi<-gam::gam(nitrate_mean ~ spec_cond + oxygen + oxygen_sat + chloro + ph + f_dom + turbidity , data = data_lewi)

step_model_gam<-gam::step.Gam(model_gam_lewi, scope=list("spec_cond"=~1+spec_cond+s(spec_cond,4)+s(spec_cond,6),
                               "oxygen"=~1+oxygen+s(oxygen,4)+s(oxygen,5)+s(oxygen,6),
                               "oxygen_sat"=~1+oxygen_sat+s(oxygen_sat,4)+s(oxygen_sat,5)+s(oxygen_sat,6),
                               "chloro"=~1+chloro+s(chloro,4)+s(chloro,5)+s(chloro,6),
                               "ph"=~1+ph+s(ph,4)+s(ph,5)+s(ph,6),
                               "f_dom"=~1+f_dom+s(f_dom,4)+s(f_dom,5)+s(f_dom,6),
                               "turbidity"=~1+turbidity+s(turbidity,4)+s(turbidity,5)+s(turbidity,6)))
```


```{r echo=T, message=FALSE, warning=FALSE, include=FALSE}
best_model_gam_lewi<-mgcv::gam(nitrate_mean ~  s(spec_cond, k = 6) + s(oxygen, k = 6) +  s(temp_mean, k = 6) + s(log(turbidity + 1 ),  k = 6)+ s(time_recod, k = 6)+ s(elev, k = 6), data = data_lewi, na.action=na.exclude)

#fill where we deleted na
data_lewi <- data_lewi %>%
  mutate(gam_res = residuals(best_model_gam_lewi)) %>%
  as_tsibble(index=start_date_time) %>%
  fill_gaps()

forecast::checkresiduals(best_model_gam_lewi)


gam_prediction<-predict(best_model_gam_lewi, data_lewi)

data_rmse<- cbind(data_lewi$nitrate_mean,gam_prediction)
data_rmse<-data_rmse[complete.cases(data_rmse),]
rmse_lewi<-Metrics::rmse(data_rmse[,1], data_rmse[,2])

lewi_res <- c(rmse_lewi, best_model_gam_lewi$gcv.ubre)


# for next plot
best_model_gam_lewi<-mgcv::gam(nitrate_mean ~  s(spec_cond, k = 6) + s(oxygen, k = 6) + s(temp_mean, k = 6) + s(log(turbidity+1),  k = 6)+ s(time_recod, k = 6)+ s(elev, k = 6), data = data_lewi)

summary(best_model_gam_lewi)
```


## TABLE RMSE and GCV

```{r message=FALSE, warning=FALSE, echo=T}
res<-rbind(round(cari_res,2), round(arik_res,2), round(lewi_res,2))
colnames(res)<- c("RMSE", "GCV")
rownames(res)<- c("Caribou", "Arikaree", "Lewis Run")
print(res)
```
## a Aic


aAIC = n log(sigma^2) + 2k  where n is the length of the time series, sigma^2 is the variance of the model residuals and k is the total number of df in both models.

for arima models df = number of observation  - number of estimated parameters

```{r}
summary(best_model_gam_lewi)
aAIC_lewi <- 13341*log(best_model_gam_lewi$sig2) + (2*sum(best_model_gam_lewi$edf))
summary(best_model_gam_arik)
aAIC_arik <- 14973*log(best_model_gam_arik$sig2) + (2*sum(best_model_gam_arik$edf))
summary(best_model_gam_cari)
aAIC_cari <- 8040*log(best_model_gam_cari$sig2) + (2*sum(best_model_gam_cari$edf))

GAMM_arik<-forecast::auto.arima(best_model_gam_arik$residuals)
aAIC_GAMM_arik <- (14973*log(GAMM_arik$sigma2)) + (sum(best_model_gam_lewi$edf) + 5)

GAMM_cari<-forecast::auto.arima(best_model_gam_cari$residuals)
aAIC_GAMM_cari <- (8040*log(GAMM_cari$sigma2)) + (sum(best_model_gam_cari$edf) + 5)

GAMM_lewi<-forecast::auto.arima(best_model_gam_lewi$residuals)
aAIC_GAMM_lewi <- (13341*log(GAMM_lewi$sigma2)) + (sum(best_model_gam_lewi$edf) + 3)


res_aAIC <- data.frame("aAIC" = c(aAIC_cari,aAIC_GAMM_cari, aAIC_arik,  aAIC_GAMM_arik,aAIC_lewi, aAIC_GAMM_lewi ))
rownames(res_aAIC)<- c("GAM Caribou","GAMM Caribou", "GAM Arikaree", "GAMM Arikaree", "GAM Lewis Run", "GAMM Lewis Run")
res_aAIC



```


# Figure 3

```{r message=FALSE, warning=FALSE, echo=T}
c <- getViz(best_model_gam_cari)
a <- getViz(best_model_gam_arik)
k <- getViz(best_model_gam_lewi)

cari1 <- plot(sm(c, 1)) + l_fitLine(colour = "red") + l_ciLine(mul = 5, colour = "blue", linetype = 2) +  xlab(expression("Spec.Cond ("~mu~"S/cm)"))   + ylab("")  +
    theme_classic()
arik1 <- plot(sm(a, 1)) + l_fitLine(colour = "red") + l_ciLine(mul = 5, colour = "blue", linetype = 2) + xlab(expression("Spec.Cond ("~mu~"S/cm)")) + theme_classic()  + ylab("s(x)")
lewi1 <- plot(sm(k, 1)) + l_fitLine(colour = "red") +l_ciLine(mul = 5, colour = "blue", linetype = 2) + xlab(expression("Spec.Cond ("~mu~"S/cm)")) + ylab("") +  theme_classic()
cari2 <- plot(sm(c, 2)) + l_fitLine(colour = "red") + l_ciLine(mul = 5, colour = "blue", linetype = 2) + xlab("Oxygen (mg/L)") + ylab("")  + theme_classic()
arik2 <- plot(sm(a, 2)) + l_fitLine(colour = "red") + l_ciLine(mul = 5, colour = "blue", linetype = 2) + xlab("Oxygen (mg/L)") +ylab("") + ylim(-5,5) + theme_classic() + ylab("s(x)")
lewi2 <- plot(sm(k, 2)) + l_fitLine(colour = "red") + l_ciLine(mul = 5, colour = "blue", linetype = 2) +  xlab("Oxygen (mg/L)") +ylab("") + 
    theme_classic()
cari3 <- plot(sm(c, 3)) + l_fitLine(colour = "red") + l_ciLine(mul = 5, colour = "blue", linetype = 2) +  xlab("Temperature (째C)") +theme_classic() +   ylab("")  
arik3 <- plot(sm(a, 3)) + l_fitLine(colour = "red") +  l_ciLine(mul = 5, colour = "blue", linetype = 2) +  xlab("Temperature (째C)") + ylim(-5,5)  + ylab("s(x)") + 
    theme_classic()
lewi3 <- plot(sm(k, 3)) + l_fitLine(colour = "red") + l_ciLine(mul = 5, colour = "blue", linetype = 2) + xlab("Temperature (째C)") +ylab("") +
     theme_classic()
cari4 <- plot(sm(c, 4)) + l_fitLine(colour = "red") +  l_ciLine(mul = 5, colour = "blue", linetype = 2) + xlab("Log_Turbidity (FNU)") + ylab("")  +
     theme_classic()
arik4 <- plot(sm(a, 4)) + l_fitLine(colour = "red") + l_ciLine(mul = 5, colour = "blue", linetype = 2) + xlab("Log_Turbidity (FNU)")   + ylab("s(x)") +
     theme_classic()
lewi4 <- plot(sm(k, 4)) + l_fitLine(colour = "red") +l_ciLine(mul = 5, colour = "blue", linetype = 2) + xlab("Log_Turbidity (FNU)") + ylab("") +
    theme_classic()
cari5 <- plot(sm(c, 5)) + l_fitLine(colour = "red") +  l_ciLine(mul = 5, colour = "blue", linetype = 2) + xlab("Time") + ylab("")  +
     theme_classic() + scale_x_continuous(labels= c("Sept-18","Jul-19"), breaks = c(10000,20000))
arik5 <- plot(sm(a, 5)) + l_fitLine(colour = "red") +  l_ciLine(mul = 5, colour = "blue", linetype = 2) + xlab("Time") +  ylab("s(x)") + 
     theme_classic() + scale_x_continuous(labels= c("Nov-18","Jun-19", "Dec-19"), breaks = c(30000,50000,70000))
lewi5 <- plot(sm(k, 5)) + l_fitLine(colour = "red") +  l_ciLine(mul = 5, colour = "blue", linetype = 2) + xlab("Time") + ylab("") +
    theme_classic() + scale_x_continuous(labels= c("Jul-18","Feb-19", "Sep-19"), breaks = c(20000,40000,60000))


cari6 <- plot(sm(c, 6)) + l_fitLine(colour = "red") +  l_ciLine(mul = 6, colour = "blue", linetype = 2) + xlab("Elevation (m)") + ylab("")  +  theme_classic()
arik6 <- plot(sm(a, 6)) + l_fitLine(colour = "red") +  l_ciLine(mul = 6, colour = "blue", linetype = 2) + xlab("Elevation (m)") +  ylab("s(x)")  +
     theme_classic()
lewi6 <- plot(sm(k, 6)) + l_fitLine(colour = "red") +  l_ciLine(mul = 6, colour = "blue", linetype = 2) + xlab("Elevation (m)") + ylab("") +   theme_classic()

gridPrint( arik1, cari1, lewi1, arik2, cari2, lewi2 ,arik3, cari3, lewi3,arik4, cari4, lewi4, arik5,cari5,  lewi5,arik6, cari6,  lewi6, ncol = 3, top = "Arikaree                                                Caribou                                                    Lewis Run")
```




# Calculating importance of variables

## ARIKAREE

```{r}
#Deviance of the GAMM 
d_null<-deviance(gam(nitrate_mean ~  1 , data = data_arik))
ar_model<-auto.arima(residuals(best_model_gam_arik))  # selecting best ARIMA model
D_GAMM_total <- deviance(best_model_gam_arik)
D_RES <- sum(residuals(ar_model)^2, na.rm=T)
Deviance_GAMM_total <- (d_null - D_RES) / d_null


# Deviances of GAMMs minus one by one covariates
GAM_elev<-mgcv::gam(nitrate_mean ~  s(spec_cond, k = 12) + s(oxygen, k = 12) +  s(temp_mean, k = 12) +
                      s(log(turbidity+1),  k = 12)+ s(time_recod, k = 12), data = data_arik, sp=best_model_gam_arik$sp[c(1:5)])
D_GAM <- deviance(GAM_elev)
D_RES <- sum(residuals(arima(residuals(GAM_elev), order = c(2,0,5)))^2, na.rm=T)
Deviance_elev <- (D_GAMM_total - D_RES) / D_GAMM_total
Deviance_elev

GAM_time<-mgcv::gam(nitrate_mean ~  s(spec_cond, k = 12) + s(oxygen, k = 12) +  s(temp_mean, k = 12) +
                      s(log(turbidity+1),  k = 12)+ s(elev, k = 12), data = data_arik, sp=best_model_gam_arik$sp[c(1:4,6)])
D_GAM <- deviance(GAM_time)
D_RES <- sum(residuals(arima(residuals(GAM_time), order = c(2,0,5)))^2, na.rm=T)
Deviance_time <- (D_GAMM_total - D_RES) / D_GAMM_total
Deviance_time


GAM_turbi<-mgcv::gam(nitrate_mean ~  s(spec_cond, k = 12) + s(oxygen, k = 12) +  s(temp_mean, k = 12) + s(time_recod, k = 12)+
                       s(elev, k = 12), data = data_arik, sp=best_model_gam_arik$sp[c(1:3,5,6)])
D_GAM <- deviance(GAM_turbi)
D_RES <- sum(residuals(arima(residuals(GAM_turbi), order = c(2,0,5)))^2, na.rm=T)
Deviance_turbi <- (D_GAMM_total - D_RES) / D_GAMM_total
Deviance_turbi


GAM_temp<-mgcv::gam(nitrate_mean ~   s(spec_cond, k = 12) +  s(oxygen, k = 12) + s(log(turbidity+1),  k = 12)+s(time_recod, k = 12)+
                      s(elev, k = 12), data = data_arik, sp=best_model_gam_arik$sp[c(1,3:6)])
D_GAM <- deviance(GAM_temp)
D_RES <- sum(residuals(arima(residuals(GAM_temp), order = c(2,0,5)))^2, na.rm=T)
Deviance_temp <- (D_GAMM_total - D_RES) / D_GAMM_total
Deviance_temp

GAM_oxygen<-mgcv::gam(nitrate_mean ~   s(spec_cond, k = 12) +  s(temp_mean, k = 12) + s(log(turbidity+1),  k = 12)+s(time_recod, k = 12)+
                        s(elev, k = 12), data = data_arik, sp=best_model_gam_arik$sp[c(1:2,4:6)])
D_GAM <- deviance(GAM_oxygen)
D_RES <- sum(residuals(arima(residuals(GAM_oxygen), order = c(2,0,5)))^2, na.rm=T)
Deviance_oxygen <- (D_GAMM_total - D_RES) / D_GAMM_total
Deviance_oxygen


GAM_cond<-mgcv::gam(nitrate_mean ~   s(oxygen, k = 12) +  s(temp_mean, k = 12) + s(log(turbidity+1),  k = 12)+s(time_recod, k = 12)+
                      s(elev, k = 12), data = data_arik, sp=best_model_gam_arik$sp[c(2:6)])
D_GAM <- deviance(GAM_cond)
D_RES <- sum(residuals(arima(residuals(GAM_cond), order = c(2,0,5)))^2, na.rm=T)
Deviance_cond <- (D_GAMM_total - D_RES) / D_GAMM_total
Deviance_cond

# deviances at arikaree
arik_dev<-c(Deviance_elev, Deviance_time,Deviance_turbi, Deviance_temp, Deviance_oxygen, Deviance_cond )
arik_imp <- data.frame("Importance" = (1-arik_dev)*100, "Var" = c("Elevation", "Time", "Turbidity", "Temperature", "Dissolved Oxygen", "Special Conductance"))
arik_imp

```

##CARIBOU

```{r}
#Deviance of the GAMM 
d_null<-deviance(gam(nitrate_mean ~  1 , data = data_cari))
ar_model<-auto.arima(residuals(best_model_gam_cari))  # selecting best ARIMA model
D_GAMM_total <- deviance(best_model_gam_cari)
D_RES <- sum(residuals(ar_model)^2, na.rm=T)
Deviance_GAMM_total <- (d_null - D_RES) / d_null


# Deviances of GAMMs minus one by one covariates
GAM_elev<-mgcv::gam(nitrate_mean ~  s(spec_cond, k = 12) + s(oxygen, k = 12) +  s(temp_mean, k = 12) +
                      s(log(turbidity+1),  k = 12)+ s(time_recod, k = 12), data = data_cari, sp=best_model_gam_cari$sp[c(1:5)])
D_GAM <- deviance(GAM_elev)
D_RES <- sum(residuals(arima(residuals(GAM_elev), order = c(2,0,5)))^2, na.rm=T)
Deviance_elev <- (D_GAMM_total - D_RES) / D_GAMM_total
Deviance_elev

GAM_time<-mgcv::gam(nitrate_mean ~  s(spec_cond, k = 12) + s(oxygen, k = 12) +  s(temp_mean, k = 12) +
                      s(log(turbidity+1),  k = 12)+ s(elev, k = 12), data = data_cari, sp=best_model_gam_cari$sp[c(1:4,6)])
D_GAM <- deviance(GAM_time)
D_RES <- sum(residuals(arima(residuals(GAM_time), order = c(2,0,5)))^2, na.rm=T)
Deviance_time <- (D_GAMM_total - D_RES) / D_GAMM_total
Deviance_time


GAM_turbi<-mgcv::gam(nitrate_mean ~  s(spec_cond, k = 12) + s(oxygen, k = 12) +  s(temp_mean, k = 12) + s(time_recod, k = 12)+
                       s(elev, k = 12), data = data_cari, sp=best_model_gam_cari$sp[c(1:3,5,6)])
D_GAM <- deviance(GAM_turbi)
D_RES <- sum(residuals(arima(residuals(GAM_turbi), order = c(2,0,5)))^2, na.rm=T)
Deviance_turbi <- (D_GAMM_total - D_RES) / D_GAMM_total
Deviance_turbi


GAM_temp<-mgcv::gam(nitrate_mean ~   s(spec_cond, k = 12) +  s(oxygen, k = 12) + s(log(turbidity+1),  k = 12)+s(time_recod, k = 12)+
                      s(elev, k = 12), data = data_cari, sp=best_model_gam_cari$sp[c(1,3:6)])
D_GAM <- deviance(GAM_temp)
D_RES <- sum(residuals(arima(residuals(GAM_temp), order = c(2,0,5)))^2, na.rm=T)
Deviance_temp <- (D_GAMM_total - D_RES) / D_GAMM_total
Deviance_temp

GAM_oxygen<-mgcv::gam(nitrate_mean ~   s(spec_cond, k = 12) +  s(temp_mean, k = 12) + s(log(turbidity+1),  k = 12)+s(time_recod, k = 12)+
                        s(elev, k = 12), data = data_cari, sp=best_model_gam_cari$sp[c(1:2,4:6)])
D_GAM <- deviance(GAM_oxygen)
D_RES <- sum(residuals(arima(residuals(GAM_oxygen), order = c(2,0,5)))^2, na.rm=T)
Deviance_oxygen <- (D_GAMM_total - D_RES) / D_GAMM_total
Deviance_oxygen


GAM_cond<-mgcv::gam(nitrate_mean ~   s(oxygen, k = 12) +  s(temp_mean, k = 12) + s(log(turbidity+1),  k = 12)+s(time_recod, k = 12)+
                      s(elev, k = 12), data = data_cari, sp=best_model_gam_cari$sp[c(2:6)])
D_GAM <- deviance(GAM_cond)
D_RES <- sum(residuals(arima(residuals(GAM_cond), order = c(2,0,5)))^2, na.rm=T)
Deviance_cond <- (D_GAMM_total - D_RES) / D_GAMM_total
Deviance_cond

# deviances at cariaree
cari_dev<-c(Deviance_elev, Deviance_time,Deviance_turbi, Deviance_temp, Deviance_oxygen, Deviance_cond )
cari_imp <- data.frame("Importance" = (1-cari_dev)*100, "Var" = c("Elevation", "Time", "Turbidity", "Temperature", "Dissolved Oxygen", "Special Conductance"))
cari_imp

```

```{r}
#Deviance of the GAMM 
d_null<-deviance(gam(nitrate_mean ~  1 , data = data_lewi))
ar_model<-auto.arima(residuals(best_model_gam_lewi))  # selecting best ARIMA model
D_GAMM_total <- deviance(best_model_gam_lewi)
D_RES <- sum(residuals(ar_model)^2, na.rm=T)
Deviance_GAMM_total <- (d_null - D_RES) / d_null


# Deviances of GAMMs minus one by one covariates
GAM_elev<-mgcv::gam(nitrate_mean ~  s(spec_cond, k = 12) + s(oxygen, k = 12) +  s(temp_mean, k = 12) +
                      s(log(turbidity+1),  k = 12)+ s(time_recod, k = 12), data = data_lewi, sp=best_model_gam_lewi$sp[c(1:5)])
D_GAM <- deviance(GAM_elev)
D_RES <- sum(residuals(arima(residuals(GAM_elev), order = c(2,0,5)))^2, na.rm=T)
Deviance_elev <- (D_GAMM_total - D_RES) / D_GAMM_total
Deviance_elev

GAM_time<-mgcv::gam(nitrate_mean ~  s(spec_cond, k = 12) + s(oxygen, k = 12) +  s(temp_mean, k = 12) +
                      s(log(turbidity+1),  k = 12)+ s(elev, k = 12), data = data_lewi, sp=best_model_gam_lewi$sp[c(1:4,6)])
D_GAM <- deviance(GAM_time)
D_RES <- sum(residuals(arima(residuals(GAM_time), order = c(2,0,5)))^2, na.rm=T)
Deviance_time <- (D_GAMM_total - D_RES) / D_GAMM_total
Deviance_time


GAM_turbi<-mgcv::gam(nitrate_mean ~  s(spec_cond, k = 12) + s(oxygen, k = 12) +  s(temp_mean, k = 12) + s(time_recod, k = 12)+
                       s(elev, k = 12), data = data_lewi, sp=best_model_gam_lewi$sp[c(1:3,5,6)])
D_GAM <- deviance(GAM_turbi)
D_RES <- sum(residuals(arima(residuals(GAM_turbi), order = c(2,0,5)))^2, na.rm=T)
Deviance_turbi <- (D_GAMM_total - D_RES) / D_GAMM_total
Deviance_turbi


GAM_temp<-mgcv::gam(nitrate_mean ~   s(spec_cond, k = 12) +  s(oxygen, k = 12) + s(log(turbidity+1),  k = 12)+s(time_recod, k = 12)+
                      s(elev, k = 12), data = data_lewi, sp=best_model_gam_lewi$sp[c(1,3:6)])
D_GAM <- deviance(GAM_temp)
D_RES <- sum(residuals(arima(residuals(GAM_temp), order = c(2,0,5)))^2, na.rm=T)
Deviance_temp <- (D_GAMM_total - D_RES) / D_GAMM_total
Deviance_temp

GAM_oxygen<-mgcv::gam(nitrate_mean ~   s(spec_cond, k = 12) +  s(temp_mean, k = 12) + s(log(turbidity+1),  k = 12)+s(time_recod, k = 12)+
                        s(elev, k = 12), data = data_lewi, sp=best_model_gam_lewi$sp[c(1:2,4:6)])
D_GAM <- deviance(GAM_oxygen)
D_RES <- sum(residuals(arima(residuals(GAM_oxygen), order = c(2,0,5)))^2, na.rm=T)
Deviance_oxygen <- (D_GAMM_total - D_RES) / D_GAMM_total
Deviance_oxygen


GAM_cond<-mgcv::gam(nitrate_mean ~   s(oxygen, k = 12) +  s(temp_mean, k = 12) + s(log(turbidity+1),  k = 12)+s(time_recod, k = 12)+
                      s(elev, k = 12), data = data_lewi, sp=best_model_gam_lewi$sp[c(2:6)])
D_GAM <- deviance(GAM_cond)
D_RES <- sum(residuals(arima(residuals(GAM_cond), order = c(2,0,5)))^2, na.rm=T)
Deviance_cond <- (D_GAMM_total - D_RES) / D_GAMM_total
Deviance_cond

# deviances at lewiaree
lewi_dev<-c(Deviance_elev, Deviance_time,Deviance_turbi, Deviance_temp, Deviance_oxygen, Deviance_cond )
lewi_imp <- data.frame("Importance" = (1-lewi_dev)*100, "Var" = c("Elevation", "Time", "Turbidity", "Temperature", "Dissolved Oxygen", "Special Conductance"))
lewi_imp

```

```{r}

total_imp<- rbind(arik_imp, cari_imp,lewi_imp)
total_imp$site<-c( rep("Arikaree", 6), rep("Caribou", 6),rep("Lewis Run", 6))

total_imp %>%
  ggplot(aes(x = Importance, y = Var, color = site, shape = site)) +
  geom_point(size = 4) +
  xlab(expression(paste("Variable importance (% of total deviance)")))+
  ylab("") +
  ggtitle("")+ 
  scale_color_manual(values=c("#440154FF", "#277F8EFF", "#9FDA3AFF"))+
  scale_shape_manual(values=c(15,16,17 ))+
  theme(legend.text = element_text(size = 13 ),
        legend.title = element_blank(),
        legend.position = "bottom",
        axis.text.x = element_text(size=14),
        axis.text.y = element_text(size=14),
        axis.title.x = element_text(size=14),
        panel.grid.major = element_line(colour = "grey", linetype = "dotted"),
        axis.line = element_line(color = "grey") )
```


# SI 2

```{r message=FALSE, warning=FALSE}
## Plot cari data

```

```{r message=FALSE, warning=FALSE}
gridExtra::grid.arrange(g1, g2,g3, layout_matrix = rbind(c(1,2,3)), widths = c(1, 1, 1))
```